<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Grab Fare Estimator (Demo)</title>

  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

  <style>
    :root { --border:#e5e7eb; --text:#111827; --muted:#6b7280; --card:#ffffff; --bg:#f9fafb; }
    * { box-sizing: border-box; }
    body { margin:0; font-family: system-ui, -apple-system, "Segoe UI", sans-serif; color:var(--text); background:var(--bg); }
    header { padding: 16px 18px; border-bottom: 1px solid var(--border); background:#fff; }
    header h1 { margin:0; font-size:18px; }
    header p { margin:6px 0 0; color:var(--muted); font-size:13px; }

    .wrap { display:grid; grid-template-columns: 380px 1fr; gap: 14px; padding: 14px; min-height: calc(100vh - 70px); }
    @media (max-width: 980px){ .wrap { grid-template-columns: 1fr; } }

    .panel { background: var(--card); border:1px solid var(--border); border-radius: 12px; padding: 14px; box-shadow: 0 1px 2px rgba(0,0,0,0.04); }
    .panel h2 { margin: 0 0 10px; font-size: 15px; }
    .grid { display:grid; gap:10px; }
    label { display:block; font-size: 12px; color: var(--muted); margin: 0 0 4px; }
    input, select, button {
      width:100%; padding:10px 10px; border:1px solid var(--border);
      border-radius: 10px; font-size: 14px; background:#fff;
    }
    button { cursor:pointer; font-weight: 600; }
    .btnRow { display:grid; grid-template-columns: 1fr 1fr; gap:10px; }
    @media (max-width: 980px){ .btnRow { grid-template-columns: 1fr; } }

    .status { font-size: 12px; color: var(--muted); margin-top: 10px; }
    .cards { display:grid; gap:10px; margin-top: 12px; }
    .card {
      border:1px solid var(--border); border-radius: 12px; padding: 12px; background:#fff;
    }
    .cardTitle { font-size: 12px; color: var(--muted); }
    .cardValue { font-size: 18px; font-weight: 700; margin-top: 3px; }
    .row2 { display:grid; grid-template-columns: 1fr 1fr; gap:10px; }
    .tiny { font-size: 12px; color: var(--muted); margin-top: 6px; line-height: 1.4; }

    #mapPanel { padding: 0; overflow:hidden; }
    #map { width: 100%; height: calc(100vh - 70px - 28px); min-height: 520px; }
    @media (max-width: 980px){ #map { height: 520px; } }
  </style>
</head>

<body>
<header>
  <h1>Grab Fare Estimator (Final Model)</h1>
  <p>Calculating fare based on <b>Regression Model from Colab</b>.</p>
</header>

<div class="wrap">
  <div class="panel">
    <h2>Trip Inputs</h2>
    <div class="grid">
      <div>
        <label for="from">üìç Pickup point</label>
        <select id="from"></select>
        <label for="to">‚õ≥ Drop-off point</label>
        <select id="to"></select>
      </div>
      <div class="row2">
        <div><label for="time">‚è∞ Time</label><input id="time" type="time" value="18:00" /></div>
        <div><label for="day">üìÖ Day</label>
          <select id="day">
            <option>Monday</option><option>Tuesday</option><option>Wednesday</option>
            <option>Thursday</option><option>Friday</option><option>Saturday</option><option>Sunday</option>
          </select>
        </div>
      </div>
      <div>
        <label for="weather">üå§ Weather</label>
        <select id="weather">
          <option value="Clear">Clear</option>
          <option value="Rain">Rain</option>
          <option value="Thunder">Thunder</option>
        </select>
      </div>
      <div class="btnRow">
        <button id="btnRoute" style="background:#eee">1. Find route</button>
        <button id="btnEstimate" style="background:#00c853; color:#fff">2. Estimate Fare</button>
      </div>
      <div class="status" id="status">Ready</div>
    </div>

    <div class="cards">
      <div class="row2">
        <div class="card"><div class="cardTitle">Distance</div><div class="cardValue" id="distanceText">‚Äî</div></div>
        <div class="card"><div class="cardTitle">Duration</div><div class="cardValue" id="durationText">‚Äî</div></div>
      </div>
      <div class="row2">
        <div class="card"><div class="cardTitle">Estimated fare</div><div class="cardValue" id="estFareText" style="color:#00c853">‚Äî</div></div>
        <div class="card"><div class="cardTitle">Actual fare (Avg)</div><div class="cardValue" id="actFareText">‚Äî</div></div>
      </div>
    </div>
  </div>
  <div class="panel" id="mapPanel"><div id="map"></div></div>
</div>

<script>
  const map = L.map("map").setView([3.1390, 101.6869], 12);
  L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", { attribution: '&copy; OSM' }).addTo(map);

  const el = {
    status: document.getElementById("status"),
    from: document.getElementById("from"),
    to: document.getElementById("to"),
    time: document.getElementById("time"),
    day: document.getElementById("day"),
    weather: document.getElementById("weather"),
    btnRoute: document.getElementById("btnRoute"),
    btnEstimate: document.getElementById("btnEstimate"),
    distanceText: document.getElementById("distanceText"),
    durationText: document.getElementById("durationText"),
    estFareText: document.getElementById("estFareText"),
    actFareText: document.getElementById("actFareText"),
  };

  const PICKUPS = [{ label: "University of Tsukuba Malaysia (UTMy)", value: "UTMy", query: "University of Tsukuba Malaysia, Kuala Lumpur" }];
  const DESTINATIONS = [
    { label: "KLCC Twin Towers", value: "KLCC", query: "Petronas Twin Towers" },
    { label: "KLIA", value: "KLIA", query: "Kuala Lumpur International Airport" },
    { label: "Mid Valley Mega Mall", value: "MidValley", query: "Mid Valley Megamall" },
    { label: "Batu Caves Temple", value: "BatuCaves", query: "Batu Caves" },
    { label: "Lalaport Bukit Bintang", value: "Lalaport", query: "LaLaport Bukit Bintang" },
    { label: "Sunway Pyramid Mall", value: "Sunway", query: "Sunway Pyramid" },
    { label: "1 Mont Kiara", value: "MontKiara", query: "1 Mont Kiara" },
    { label: "Laurel Residence", value: "Laurel", query: "Laurel Residence Bangsar South" },
    { label: "Taylor's University", value: "Taylors", query: "Taylor's University Lakeside Campus" },
    { label: "1 Utama Shopping mall", value: "1Utama", query: "1 Utama Shopping Centre" }
  ];

function populate() {
  // Pickup
  el.from.innerHTML = '<option value="">Select pickup</option>';
  PICKUPS.forEach(p => {
    const o = new Option(p.label, p.value);
    o.dataset.query = p.query;
    el.from.add(o);
  });

  // Destination
  el.to.innerHTML = '<option value="">Select destination</option>';
  DESTINATIONS.forEach(d => {
    const o = new Option(d.label, d.value);
    o.dataset.query = d.query;
    el.to.add(o);
  });
}
populate();


  let lastRoute = null;

  async function findRoute(){
    const fQ = el.from.options[el.from.selectedIndex]?.dataset.query;
    const tQ = el.to.options[el.to.selectedIndex]?.dataset.query;
    if(!fQ || !tQ) return alert("Select points");
    
    el.status.textContent = "Routing...";
    try {
      const resA = await fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${fQ}`);
      const dataA = await resA.json();
      const resB = await fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${tQ}`);
      const dataB = await resB.json();
      
      const osrm = await fetch(`https://router.project-osrm.org/route/v1/driving/${dataA[0].lon},${dataA[0].lat};${dataB[0].lon},${dataB[0].lat}?overview=full&geometries=geojson`);
      const routeData = await osrm.json();
      const r = routeData.routes[0];

      L.geoJSON(r.geometry).addTo(map);
      map.fitBounds(L.geoJSON(r.geometry).getBounds());

      lastRoute = { km: r.distance/1000, min: r.duration/60 };
      el.distanceText.textContent = lastRoute.km.toFixed(2) + " km";
      el.durationText.textContent = Math.round(lastRoute.min) + " min";
      el.status.textContent = "Route found.";
    } catch(e) { el.status.textContent = "Error finding route."; }
  }

  // ‚òÖ„Åì„Åì„ÅåColab„ÅÆÊï∞Â≠ó„Çí‰Ωø„Å£„ÅüË®àÁÆóÈÉ®ÂàÜ
  function estimateFare(km, min, weather, day){
    // --- Colab„ÅÆÊï∞Â≠ó„ÇíÈÅ©Áî® ---
    const b0 = 18.62722664618949; // ÂàáÁâá
    const bDist = 1.6685;         // È†ÖÁõÆ 61: Ë∑ùÈõ¢„ÅÆ‰øÇÊï∞
    const bDur = 0.2750;          // È†ÖÁõÆ 68: ÊôÇÈñì„ÅÆ‰øÇÊï∞
    const bRain = 1.7932;         // È†ÖÁõÆ 5: Èõ®„ÅÆ‰øÇÊï∞
    const bThun = 3.5023;         // È†ÖÁõÆ 6: Èõ∑„ÅÆ‰øÇÊï∞
    const bPeak = 1.9867;         // È†ÖÁõÆ 47: „Éî„Éº„ÇØ„ÅÆ‰øÇÊï∞
    // ------------------------

    let isRain = (weather === "Rain" ? 1 : 0);
    let isThun = (weather === "Thunder" ? 1 : 0);
    
    // Á∞°ÊòìÁöÑ„Å™„Éî„Éº„ÇØÂà§ÂÆöÔºà17-20ÊôÇÔºâ
    const hr = parseInt(el.time.value.split(":")[0]);
    let isPeak = (hr >= 17 && hr <= 20) ? 1 : 0;

    return b0 + (bDist * km) + (bDur * min) + (bRain * isRain) + (bThun * isThun) + (bPeak * isPeak);
  }

  el.btnRoute.onclick = findRoute;
  el.btnEstimate.onclick = () => {
    if(!lastRoute) return alert("Find route first");
    const fare = estimateFare(lastRoute.km, lastRoute.min, el.weather.value, el.day.value);
    el.estFareText.textContent = "RM " + fare.toFixed(2);
  };

populatePickups();
populateDestinations();
loadModel();   // ‚Üê model.json
</script>
</body>
</html>
