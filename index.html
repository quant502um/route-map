<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Route Finder</title>

  <!-- Leaflet -->
  <link
    rel="stylesheet"
    href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
  />
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

  <style>
    body { margin:0; font-family: system-ui, -apple-system, "Segoe UI", sans-serif; }
    #topbar { padding: 12px; display: grid; gap: 8px; background:#fff; }
    #topbar input { padding:10px; font-size:14px; width:100%; }
    #topbar button { padding:10px; font-size:14px; cursor:pointer; }
    #map { height: calc(100vh - 140px); }
    #status { font-size: 13px; opacity: 0.85; }
    @media (min-width: 700px){
      #topbar { grid-template-columns: 1fr 1fr auto; align-items:center; }
      #status { grid-column: 1 / -1; }
      #map { height: calc(100vh - 80px); }
    }
  </style>
</head>
<body>
  <div id="topbar">
    <input id="from" placeholder="出発地（例: 28 Mont Kiara / KL Sentral）" />
    <input id="to" placeholder="目的地（例: Four Seasons Hotel KL）" />
    <button id="btn">ルート検索</button>
    <div id="status">出発地と目的地を入れて「ルート検索」。</div>
  </div>
  <div id="map"></div>

  <script>
    const statusEl = document.getElementById("status");

    // 地図（初期はKL周辺）
    const map = L.map("map").setView([3.1390, 101.6869], 12);
    L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
      maxZoom: 19,
      attribution: "&copy; OpenStreetMap contributors"
    }).addTo(map);

    let fromMarker, toMarker, routeLine;

    function setStatus(msg){ statusEl.textContent = msg; }

    async function geocode(query){
      // Nominatim（OSMの地名検索）※連打しない前提
      const url = `https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(query)}`;
      const res = await fetch(url, { headers: { "Accept-Language": "en" }});
      if(!res.ok) throw new Error("geocode failed");
      const data = await res.json();
      if(!data.length) return null;
      return { lat: parseFloat(data[0].lat), lon: parseFloat(data[0].lon), name: data[0].display_name };
    }

    async function route(from, to){
      // OSRM public server（車ルート）
      const url =
        `https://router.project-osrm.org/route/v1/driving/${from.lon},${from.lat};${to.lon},${to.lat}` +
        `?overview=full&geometries=geojson&steps=false`;
      const res = await fetch(url);
      if(!res.ok) throw new Error("route failed");
      const data = await res.json();
      if(!data.routes || !data.routes.length) return null;
      return data.routes[0];
    }

    function clearOld(){
      if(fromMarker) map.removeLayer(fromMarker);
      if(toMarker) map.removeLayer(toMarker);
      if(routeLine) map.removeLayer(routeLine);
    }

    document.getElementById("btn").addEventListener("click", async () => {
      const fromText = document.getElementById("from").value.trim();
      const toText   = document.getElementById("to").value.trim();
      if(!fromText || !toText){
        setStatus("出発地・目的地の両方を入力してね。");
        return;
      }

      try{
        setStatus("場所を検索中…");
        const [fromLoc, toLoc] = await Promise.all([geocode(fromText), geocode(toText)]);
        if(!fromLoc || !toLoc){
          setStatus("場所が見つからなかった…表記を変えて再検索してみて。");
          return;
        }

        setStatus("ルート計算中…");
        const r = await route(fromLoc, toLoc);
        if(!r){
          setStatus("ルートが取得できなかった…");
          return;
        }

        clearOld();

        fromMarker = L.marker([fromLoc.lat, fromLoc.lon]).addTo(map).bindPopup("From: " + fromLoc.name);
        toMarker   = L.marker([toLoc.lat, toLoc.lon]).addTo(map).bindPopup("To: " + toLoc.name);

        routeLine = L.geoJSON(r.geometry).addTo(map);

        // 距離・時間表示
        const km = (r.distance / 1000).toFixed(1);
        const min = Math.round(r.duration / 60);
        setStatus(`距離: ${km} km / 目安時間: ${min} 分`);

        // 全体が見えるようにズーム
        const bounds = routeLine.getBounds();
        map.fitBounds(bounds, { padding: [20, 20] });

      }catch(e){
        console.error(e);
        setStatus("エラーが出た…時間をおいて再試行してね。");
      }
    });
  </script>
</body>
</html>
