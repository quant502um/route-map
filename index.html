
<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Grab Fare Estimator (Demo)</title>

  <!-- Leaflet -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

  <style>
    :root { --border:#e5e7eb; --text:#111827; --muted:#6b7280; --card:#ffffff; --bg:#f9fafb; }
* { box-sizing: border-box; }
body { margin:0; font-family: system-ui, -apple-system, "Segoe UI", sans-serif; color:var(--text); background:var(--bg); }
header { padding: 16px 18px; border-bottom: 1px solid var(--border); background:#fff; }
header h1 { margin:0; font-size:18px; }
header p { margin:6px 0 0; color:var(--muted); font-size:13px; }

.panel h2 { margin: 0 0 10px; font-size: 15px; }

.grid { display:grid; gap:10px; }
label { display:block; font-size: 12px; color: var(--muted); margin: 0 0 4px; }

input, select, button {
  width:100%;
  padding:10px 10px;
  border:1px solid var(--border);
  border-radius: 10px;
  font-size: 14px;
  background:#fff;
}

button { cursor:pointer; font-weight: 600; }
.btnRow { display:grid; grid-template-columns: 1fr 1fr; gap:10px; }
.status { font-size: 12px; color: var(--muted); margin-top: 10px; }

.cards { display:grid; gap:10px; margin-top: 12px; }
.card { border:1px solid var(--border); border-radius: 12px; padding: 12px; background:#fff; }
.cardTitle { font-size: 12px; color: var(--muted); }
.cardValue { font-size: 18px; font-weight: 700; margin-top: 3px; }
.row2 { display:grid; grid-template-columns: 1fr 1fr; gap:10px; }
.tiny { font-size: 12px; color: var(--muted); margin-top: 6px; line-height: 1.4; }

/* ===== 2-column layout (PC) ===== */
.wrap{
  display:flex;
  gap:16px;
  align-items:stretch;
  padding:14px;
}

.panel{
  width:380px;
  flex:0 0 380px;
}

.mapWrap{
  flex:1 1 auto;
  min-width:0;
}

#map{
  width:100%;
  min-height:640px;
  height: calc(100vh - 160px);
  border-radius:14px;
}

/* „Çπ„Éû„Éõ„Å†„ÅëÁ∏¶„Å´„Åó„Åü„ÅÑ„Å™„ÇâÔºà‰ªªÊÑèÔºâ */
@media (max-width: 700px){
  .wrap{ flex-direction: column; }
  #map{ height: 520px; min-height: 520px; }
}
  </style>
</head>

<body>
<header>
  <h1>Grab Fare Estimator (Demo)</h1>
  <p>Enter trip details to visualize the route and compare <b>Estimated</b> vs <b>Actual</b> fare (from your dataset).</p>
</header>

<div class="wrap">
  <div class="panel">
    <h2>Trip Inputs</h2>

    <div class="grid">
      <div>
       <label for="from">üìç Pickup point</label>
<input id="from" value="University of Tsukuba Malaysia (UTMy)" readonly />
<label for="to">‚õ≥ Drop-off point</label>
<select id="to">
  <option value="" disabled selected>Select a destination</option>

  <option value="KLCC, Kuala Lumpur City Centre, Kuala Lumpur">KLCC Twin Towers</option>
  <option value="1 Mont Kiara, Mont Kiara, Kuala Lumpur">1 Mont Kiara</option>
  <option value="Sunway Pyramid, Bandar Sunway, Petaling Jaya">Sunway Pyramid Mall</option>
  <option value="Lalaport Bukit Bintang City Centre, Kuala Lumpur">Lalaport Bukit Bintang</option>
  <option value="Batu Caves, Selangor">Batu Caves Temple</option>
  <option value="Taylor&#39;s University Lakeside Campus, Subang Jaya">Taylor&#39;s University</option>
  <option value="KLIA (Terminal 1)">KLIA (Terminal 1)</option>
  <option value="Mid Valley Megamall, Lingkaran Syed Putra, Kuala Lumpur">Mid Valley Mega Mall</option>
  <option value="1 Utama Shopping Centre, Bandar Utama, Petaling Jaya">1 Utama Shopping Mall</option>
  <option value="Laurel Residence Mont Kiara, Kuala Lumpur">Laurel Residence</option>
</select>

      <div class="row2">
        <div>
         <label for="time">‚è∞ Time</label>
<input id="time" type="time" />
        </div>
        <div>
  <label for="day">üìÖ Day</label>
  <select id="day">
    <option>Monday</option>
    <option>Tuesday</option>
    <option>Wednesday</option>
    <option>Thursday</option>
    <option>Friday</option>
    <option>Saturday</option>
    <option>Sunday</option>
  </select>
</div>
      </div>

      <div>
      <label for="weather">üå§ Weather</label>
<select id="weather">
  <option value="Clear">Clear</option>
  <option value="Rain">Rain</option>
  <option value="Thunder">Thunder</option>
</select>
      </div>

      <div class="btnRow">
        <button id="btnRoute">Find route</button>
        <button id="btnEstimate">Estimate & Compare</button>
      </div>

      <div class="status" id="status">Loading dataset‚Ä¶</div>
    </div>

    <div class="cards">
      <div class="row2">
        <div class="card">
          <div class="cardTitle">Distance</div>
          <div class="cardValue" id="distanceText">‚Äî</div>
        </div>
        <div class="card">
          <div class="cardTitle">Duration</div>
          <div class="cardValue" id="durationText">‚Äî</div>
        </div>
      </div>

      <div class="row2">
        <div class="card">
          <div class="cardTitle">Estimated fare (RM)</div>
          <div class="cardValue" id="estFareText">‚Äî</div>
        </div>
        <div class="card">
          <div class="cardTitle">Actual fare (RM)</div>
          <div class="cardValue" id="actFareText">‚Äî</div>
        </div>
      </div>

      <div class="card">
        <div class="cardTitle">Difference (Actual ‚àí Estimated)</div>
        <div class="cardValue" id="diffText">‚Äî</div>
        <div class="tiny" id="matchInfo">
          Actual fare is computed from the dataset by averaging trips with similar distance/time/weather/day.
        </div>
      </div>
    </div>

    <div class="tiny">
      <b>Note:</b> This demo uses OpenStreetMap (Nominatim) + OSRM for routing.  
      Replace the coefficients in <code>estimateFare()</code> later with your regression results.
    </div>
  </div>

   </div>
  <div class="mapWrap">
    <div id="map"></div>
  </div>
</div>
<script>
  let model = null;

async function loadModel(){
  try{
    const res = await fetch("./model.json", { cache: "no-store" });
    if (!res.ok) throw new Error("model.json not found");
    model = await res.json();
    console.log("‚úÖ model.json loaded:", model);
  } catch(e){
    console.warn("‚ö†Ô∏è model.json not loaded:", e);
    model = null;
  }
}
  // =========================
  // Map + Routing (Leaflet + OSM + OSRM)
  // =========================
  const map = L.map("map").setView([3.1390, 101.6869], 12);
  setTimeout(() => map.invalidateSize(true), 300);


  L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
    maxZoom: 19,
    attribution: '&copy; OpenStreetMap contributors'
  }).addTo(map);

  // Google Sites iframe resize safety
  setTimeout(() => map.invalidateSize(), 500);
  window.addEventListener("resize", () => map.invalidateSize());

  let fromMarker = null, toMarker = null, routeLine = null;
  let lastRoute = null; // {distance_km, duration_min}

  const el = {
    status: document.getElementById("status"),
    from: document.getElementById("from"),
    to: document.getElementById("to"),
    time: document.getElementById("time"),
    day: document.getElementById("day"),
    weather: document.getElementById("weather"),
    btnRoute: document.getElementById("btnRoute"),
    btnEstimate: document.getElementById("btnEstimate"),
    distanceText: document.getElementById("distanceText"),
    durationText: document.getElementById("durationText"),
    estFareText: document.getElementById("estFareText"),
    actFareText: document.getElementById("actFareText"),
    diffText: document.getElementById("diffText"),
    matchInfo: document.getElementById("matchInfo"),
  };

  function setStatus(msg){ el.status.textContent = msg; }
  function rm(x){ return x == null ? "‚Äî" : `RM ${Number(x).toFixed(2)}`; }

  function clearMap(){
    if (fromMarker) map.removeLayer(fromMarker);
    if (toMarker) map.removeLayer(toMarker);
    if (routeLine) map.removeLayer(routeLine);
    fromMarker = toMarker = routeLine = null;
    lastRoute = null;
  }

  async function geocode(q){
    const url = "https://nominatim.openstreetmap.org/search?format=json&q=" + encodeURIComponent(q);
    const res = await fetch(url, { headers: { "Accept-Language": "en" } });
    const data = await res.json();
    if (!data || data.length === 0) return null;
    return { lat: parseFloat(data[0].lat), lon: parseFloat(data[0].lon), name: data[0].display_name };
  }
const FIXED_PLACES = {
  "UTMy": { lat: 3.120071, lon: 101.666759, name: "University of Tsukuba Malaysia" },

  "KLIA (Terminal 1)": { lat: 2.786557, lon: 101.688872, name: "KLIA Terminal 1" },
  "1 Utama Shopping Centre, Bandar Utama, Petaling Jaya": { lat: 3.149771, lon: 101.615390, name: "1 Utama Shopping Centre" },
  "Laurel Residence Mont Kiara, Kuala Lumpur": { lat: 3.173990, lon: 101.664070, name: "Laurel Residence Mont Kiara" },
};


async function getLocation(q){
  if (FIXED_PLACES[q]) return FIXED_PLACES[q];

  const key = Object.keys(FIXED_PLACES).find(k =>
    k.toLowerCase() === q.toLowerCase() || q.toLowerCase().includes(k.toLowerCase())
  );
  if (key) return FIXED_PLACES[key];

  return await geocode(q);
}


  async function routeOSRM(from, to){
    const url = `https://router.project-osrm.org/route/v1/driving/${from.lon},${from.lat};${to.lon},${to.lat}?overview=full&geometries=geojson`;
    const res = await fetch(url);
    const data = await res.json();
    if (!data || data.code !== "Ok" || !data.routes?.length) return null;
    const r = data.routes[0];
    return { distance_m: r.distance, duration_s: r.duration, geojson: r.geometry };
  }

  function formatKm(km){ return `${km.toFixed(2)} km`; }
  function formatMin(min){ return `${Math.round(min)} min`; }

  async function findRoute(){
   const fromQ = "University of Tsukuba Malaysia, Kuala Lumpur";
const toQ = el.to.value.trim();

if (!toQ) {
  setStatus("Please select a drop-off location.");
  return;
}

    try{
      clearMap();
      setStatus("Searching locations‚Ä¶");
      const [a,b] = await Promise.all([getLocation("UTMy"), getLocation(toQ)]);
      if (!a) { setStatus("Pickup point not found. Try a more specific name."); return; }
      if (!b) { setStatus("Drop-off point not found. Try a more specific name."); return; }

      setStatus("Calculating route‚Ä¶");
      const rt = await routeOSRM(a,b);
      if (!rt) { setStatus("Route not found. Try different locations."); return; }

      fromMarker = L.marker([a.lat, a.lon]).addTo(map).bindPopup("Pickup").openPopup();
      toMarker = L.marker([b.lat, b.lon]).addTo(map).bindPopup("Drop-off");

      routeLine = L.geoJSON(rt.geojson, { style: { weight: 5, opacity: 0.85 } }).addTo(map);
      map.fitBounds(routeLine.getBounds(), { padding:[30,30] });
      setTimeout(() => map.invalidateSize(), 300);

      const distance_km = rt.distance_m / 1000;
      const duration_min = rt.duration_s / 60;

      lastRoute = { distance_km, duration_min };

      el.distanceText.textContent = formatKm(distance_km);
      el.durationText.textContent = formatMin(duration_min);

      setStatus("Route ready. Click ‚ÄúEstimate & Compare‚Äù.");
    } catch(err){
      console.error(err);
      setStatus("Sorry‚Äîsomething went wrong. Please try again.");
    }
  }

  // =========================
  // Dataset: load CSV from repo (data.csv)
  // =========================
  let dataset = []; // normalized rows

  function parseCSV(text){
    // simple CSV parser (works if your fields don't include commas inside quotes)
    const lines = text.trim().split(/\r?\n/);
    const headers = lines[0].split(",").map(h => h.trim());
    return lines.slice(1).map(line => {
      const cols = line.split(",").map(c => c.trim());
      const row = {};
      headers.forEach((h,i) => row[h] = cols[i]);
      return row;
    });
  }

  function dayToWeekend(day){
    const d = String(day || "").toLowerCase();
    return (d === "saturday" || d === "sunday") ? 1 : 0;
  }

  function hourFromTime(t){
    // "15:15" -> 15
    if (!t) return null;
    const m = String(t).match(/^(\d{1,2}):/);
    return m ? Number(m[1]) : null;
  }

  function isPeakHour(hour){
    // you can change this rule later
    if (hour == null) return 0;
    // typical peak windows (demo)
    return (hour >= 7 && hour <= 9) || (hour >= 17 && hour <= 20) ? 1 : 0;
  }

  async function loadDataset(){
    try{
      const res = await fetch("./data.csv", { cache: "no-store" });
      if (!res.ok) throw new Error("data.csv not found");
      const text = await res.text();
      const rows = parseCSV(text);

      // Normalize
dataset = rows.map(r => {
  const w = String(r.weather || "Clear").trim().toLowerCase();

  const weather =
    (w === "thunder" || w === "thunderstorm") ? "Thunder"
    : (w === "rain") ? "Rain"
    : "Clear";

  return {
    day_type: r.day_type,
    time: r.time,
    hour: hourFromTime(r.time),
    duration_min: Number(r.duration_min),
    distance_km: Number(r.distance_km),

    weather,
    rain: (weather === "Rain") ? 1 : 0,
    thunder: (weather === "Thunder") ? 1 : 0,

    weekend: dayToWeekend(r.day_type),
    price_rm: Number(r.price_rm),
  };
}).filter(r =>
  Number.isFinite(r.duration_min) &&
  Number.isFinite(r.distance_km) &&
  Number.isFinite(r.price_rm)
);

      setStatus(`Dataset loaded (${dataset.length} trips).`);
    } catch(err){
      console.error(err);
      setStatus("Dataset not loaded. Please add data.csv to the repo.");
      el.matchInfo.textContent = "Add data.csv to show Actual fare.";
    }
  }

  // =========================
  // Fare: Estimated (placeholder) + Actual from dataset
  // =========================
 function estimateFare(feat){
  // model.json „Åå„ÅÇ„Çã„Å™„Çâ„Åù„Çå„Çí‰Ωø„ÅÜ
  if (model && model.coefficients){
    let y = Number(model.intercept || 0);

    for (const [k, v] of Object.entries(model.coefficients)){
      y += Number(v) * Number(feat[k] ?? 0);
    }
    return y;
  }

  // „Éï„Ç©„Éº„É´„Éê„ÉÉ„ÇØÔºàmodel.json „ÅåË™≠„ÇÅ„Å™„ÅÑÊôÇÔºâ
  const b0 = 4.50, bDist = 1.65, bDur = 0.28, bPeak = 2.00, bRain = 1.80, bThunder = 3.00;
  return b0 + bDist*feat.distance_km + bDur*feat.duration_min + bPeak*feat.peak + bRain*feat.rain + bThunder*feat.thunder;
}

  function actualFareFromDataset(query){
    if (!dataset.length) return { value: null, used: 0, note: "Dataset missing." };

    // Matching rules (tweakable)
    const distTol = 1.0;     // within ¬±1 km
    const durTol = 5.0;      // within ¬±5 min
    const hourTol = 2;       // within ¬±2 hours

    const matches = dataset.filter(d => {
      const distOk = Math.abs(d.distance_km - query.distance_km) <= distTol;
      const durOk  = Math.abs(d.duration_min - query.duration_min) <= durTol;

      const weatherOk = (d.weather === query.weather);
      const weekendOk = (d.weekend === query.weekend);

      // time matching (optional)
      const hourOk = (d.hour == null || query.hour == null) ? true : (Math.abs(d.hour - query.hour) <= hourTol);

      return distOk && durOk && weatherOk && weekendOk && hourOk;
    });

    if (!matches.length){
      return { value: null, used: 0, note: "No close matches. Try relaxing the rules." };
    }

    const avg = matches.reduce((s,x)=>s + x.price_rm, 0) / matches.length;
    return { value: avg, used: matches.length, note: `Matched ${matches.length} trips (¬±${distTol} km, ¬±${durTol} min, same weather & day type).` };
  }

  function estimateAndCompare(){
    if (!lastRoute){
      setStatus("Please click ‚ÄúFind route‚Äù first.");
      return;
    }

    const hour = hourFromTime(el.time.value);
const weekend = dayToWeekend(el.day.value);

const wUIRaw = String(el.weather.value || "Clear").trim();
const wLower = wUIRaw.toLowerCase();
const weather =
  (wLower === "thunder" || wLower === "thunderstorm") ? "Thunder"
  : (wLower === "rain") ? "Rain"
  : "Clear";

const rain = (weather === "Rain") ? 1 : 0;
const thunder = (weather === "Thunder") ? 1 : 0;
const peak = isPeakHour(hour);   // ‚Üê„Åì„Çå„ÇíËøΩÂä†ÔºàÈáçË¶ÅÔºâ

const features = { ...lastRoute, hour, weekend, weather, rain, thunder, peak };
console.log("FEATURES USED IN WEB:", features);

if (model && model.coefficients) {
  let y = Number(model.intercept || 0);
  const terms = [];
  for (const [k, v] of Object.entries(model.coefficients)) {
const x = Number(features[k] ?? 0);
    const c = Number(v);
    const contrib = c * x;
    terms.push({ k, x, c, contrib });
    y += contrib;
  }
  terms.sort((a,b)=>Math.abs(b.contrib)-Math.abs(a.contrib));
  console.table(terms);
  console.log("PRED_WEB:", y);
}

    const est = estimateFare(features);

    const act = actualFareFromDataset(features);

    el.estFareText.textContent = rm(est);
    el.actFareText.textContent = act.value == null ? "‚Äî" : rm(act.value);
    el.diffText.textContent = (act.value == null) ? "‚Äî" : rm(act.value - est);

    el.matchInfo.textContent = act.note + (dataset.length ? ` (Dataset size: ${dataset.length})` : "");
    setStatus("Done.");
  }

  // =========================
  // Wire events
  // =========================
  el.btnRoute.addEventListener("click", findRoute);
  el.btnEstimate.addEventListener("click", estimateAndCompare);

el.to && el.to.addEventListener("change", () => findRoute());

  // Start
  loadDataset();
  loadModel();
</script>
</body>
</html>
